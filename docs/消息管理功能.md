# 消息管理功能文档

## 1. 相关代码文件路径

消息管理功能涉及以下代码文件：

### 路由层 (Router)
- [router/message_manage.py](file:///D:/work/meeting_assistant/router/message_manage.py) - 消息管理API路由定义
- [router/websocket_message.py](file:///D:/work/meeting_assistant/router/websocket_message.py) - WebSocket消息推送路由

### 服务层 (Service)
- [services/message_service.py](file:///D:/work/meeting_assistant/services/message_service.py) - 消息业务逻辑实现
- [services/redis_service.py](file:///D:/work/meeting_assistant/services/redis_service.py) - Redis缓存服务，用于消息缓存和未读计数
- [websocket/messages_manager.py](file:///D:/work/meeting_assistant/websocket/messages_manager.py) - WebSocket连接管理器，用于实时消息推送

### 数据模型层 (Model)
- [services/service_models.py](file:///D:/work/meeting_assistant/services/service_models.py) - 消息相关的数据库模型定义
- [schemas.py](file:///D:/work/meeting_assistant/schemas.py) - 消息相关的请求/响应数据模型

### 数据库初始化脚本
- [db/sql/mysql_messages_init.sql](file:///D:/work/meeting_assistant/db/sql/mysql_messages_init.sql) - MySQL消息表初始化脚本
- [db/sql/mysql_message_recipients_init.sql](file:///D:/work/meeting_assistant/db/sql/mysql_message_recipients_init.sql) - MySQL消息接收者表初始化脚本
- [db/sql/dameng_messages_init.sql](file:///D:/work/meeting_assistant/db/sql/dameng_messages_init.sql) - 达梦数据库消息表初始化脚本


## 2. 模块间调用关系分析

### 2.1 整体架构
消息管理功能采用典型的三层架构：
```
API层 (router) → 业务逻辑层 (service) → 数据访问层 (model)
```

### 2.2 详细调用关系

#### 2.2.1 API请求处理流程
1. **消息发送流程**
   - 用户通过 [router/message_manage.py](file:///D:/work/meeting_assistant/router/message_manage.py) 的 `/send` 接口发送消息
   - 路由层调用 [services/message_service.py](file:///D:/work/meeting_assistant/services/message_service.py) 的 `send_message` 方法
   - 消息服务层：
     - 创建消息记录并保存到数据库
     - 更新Redis缓存
     - 通过 [websocket/messages_manager.py](file:///D:/work/meeting_assistant/websocket/messages_manager.py) 向在线用户推送消息

2. **消息查询流程**
   - 用户通过 [router/message_manage.py](file:///D:/work/meeting_assistant/router/message_manage.py) 的 `/list` 接口查询消息
   - 路由层调用 [services/message_service.py](file:///D:/work/meeting_assistant/services/message_service.py) 的 `list_messages` 方法
   - 消息服务层从数据库查询消息，并结合Redis缓存优化性能

3. **消息状态更新流程**
   - 用户通过 [router/message_manage.py](file:///D:/work/meeting_assistant/router/message_manage.py) 的 `/mark-read` 接口标记消息已读
   - 路由层调用 [services/message_service.py](file:///D:/work/meeting_assistant/services/message_service.py) 的 `mark_read` 方法
   - 消息服务层更新数据库记录并清除相关Redis缓存

#### 2.2.2 模块依赖关系
```
router/message_manage.py
├── services/message_service.py
│   ├── services/service_models.py (Message, MessageRecipient)
│   ├── services/redis_service.py
│   └── websocket/messages_manager.py
├── schemas.py (MessageCreate, MessageResponse等)
└── services/auth_dependencies.py (认证依赖)

router/websocket_message.py
├── websocket/messages_manager.py
├── services/message_service.py
└── services/auth_service.py

main.py
├── router/message_manage.py
└── router/websocket_message.py
```

#### 2.2.3 数据库交互
- 消息数据通过 [services/service_models.py](file:///D:/work/meeting_assistant/services/service_models.py) 中定义的SQLAlchemy模型进行ORM操作
- 消息表(messages)存储消息内容
- 消息接收者表(message_recipients)存储消息与用户的关系及已读状态

#### 2.2.4 缓存机制
- 使用 [services/redis_service.py](file:///D:/work/meeting_assistant/services/redis_service.py) 提供的Redis服务进行缓存
- 缓存未读消息数量，减少数据库查询压力
- 消息发送或状态变更时及时清除相关缓存

#### 2.2.5 实时推送
- 通过 [websocket/messages_manager.py](file:///D:/work/meeting_assistant/websocket/messages_manager.py) 管理WebSocket连接
- 新消息发送时实时推送给在线用户
- 支持同一用户的多设备同时在线

### 2.3 核心数据流
```
用户发送消息请求
    ↓
API路由处理
    ↓
消息服务处理
    ↓
数据库持久化 + Redis缓存更新
    ↓
WebSocket实时推送(在线用户)
    ↓
返回响应给发送者
```