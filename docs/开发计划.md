# 📘 Meeting Assistant 消息系统：开发计划调整版（基于当前项目状态）

> 📊 **当前项目状态分析**：  
> - ✅ JWT 用户认证已完整实现（AuthService + 中间件）
> - ✅ 基础消息系统已实现（MessageService + API路由）
> - ✅ WebSocket连接管理器已实现（用于会议转录）
> - ✅ MySQL数据库已配置（messages表已存在）
> - ❌ Redis连接池**未实现**（需要添加）
> - ❌ 消息实时推送**未实现**（需要开发）
> - ❌ 离线消息同步**未实现**（需要开发）
>  
> 🎯 **调整策略**：基于现有基础，重点补充Redis集成和实时推送功能

---

## 🔹 阶段 0：Redis集成与消息表结构优化

### 📌 开发文档

**目标**  
集成Redis连接池，优化现有消息表结构以支持多接收者模式。

**当前状态分析**
- ✅ 已有 `messages` 表（单接收者模式）
- ❌ 缺少 `message_recipients` 表（多接收者支持）
- ❌ 未配置Redis连接

**功能节点**
1. **Redis集成**
   - 添加Redis依赖：`redis>=4.0.0` 到 requirements.txt
   - 创建 `services/redis_service.py`：连接池配置
   - 环境变量配置：`REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`
   
2. **数据库表结构调整**
   - `messages` 表：
     - `id`, `title`, `content`, `sender_id`, `type`, `created_at`
     - ❌ 不再包含 `receiver_id`
   - 新增 `message_recipients` 表：
     - `id`, `message_id`, `recipient_id`, `is_read` (default false), `read_at`, `created_at`
     - 唯一索引：`(message_id, recipient_id)`
   
3. **MessageService增强**
   - 修改发送逻辑：支持多接收者
   - 添加Redis缓存支持

**关键设计**
- 双写模式：同时写入 `messages.receiver_id` 和 `message_recipients` 表
- Redis配置可选：未配置时降级为数据库模式

---

### ✅ 验收标准

| 测试项 | 预期结果 |
|--------|--------|
| 1. Redis连接池正常工作，支持基本操作 | ✔️ |
| 2. `message_recipients` 表创建成功 | ✔️ |
| 3. 现有消息API保持兼容性 | ✔️ |
| 4. 新增多接收者发送功能 | ✔️ |
| 5. Redis未配置时系统正常降级 | ✔️ |

---

## 🔹 阶段 1：WebSocket消息推送集成

### 📌 开发文档

**目标**  
基于现有WebSocket管理器，扩展支持用户消息推送功能。

**当前状态分析**
- ✅ 已有 `ConnectionManager` 类（用于会议转录）
- ✅ WebSocket路由 `/ws/{meeting_id}` 已实现
- ❌ 缺少用户级别的WebSocket连接管理
- ❌ 缺少JWT认证集成

**功能节点**
- 扩展现有 `ConnectionManager`：添加用户连接管理
- 新增WebSocket路由：`/ws/user/messages`
- JWT Token验证：WebSocket连接时验证用户身份
- 消息推送接口：`send_user_message(user_id, message)`
- 在线状态管理：Redis Hash存储在线用户

**关键设计**
- 复用现有WebSocket基础设施
- 支持用户多设备同时在线
- 与会议WebSocket功能隔离

---

### ✅ 验收标准

| 测试项 | 预期结果 |
|--------|--------|
| 1. 用户WebSocket连接成功，JWT验证通过 | ✔️ |
| 2. 在线用户状态正确存储到Redis | ✔️ |
| 3. 消息推送功能正常工作 | ✔️ |
| 4. 会议WebSocket功能不受影响 | ✔️ |
| 5. 多设备同时在线支持 | ✔️ |

---

## 🔹 阶段 2：消息异步分发优化

### 📌 开发文档

**目标**  
基于现有MessageService，添加异步推送和Redis队列支持。

**当前状态分析**
- ✅ MessageService已实现基础CRUD功能
- ✅ 消息发送API已存在
- ❌ 缺少异步推送机制
- ❌ 缺少消息队列处理

**功能节点**
- 修改现有发送逻辑：添加异步推送任务
- Redis队列：`message_delivery_queue`
- 后台消费者：处理推送任务
- 推送失败处理：重试机制

**关键设计**
- 保持现有API响应速度
- 推送与发送解耦
- 支持批量推送优化

---

### ✅ 验收标准

| 测试项 | 预期结果 |
|--------|--------|
| 1. 消息发送API响应时间保持 < 100ms | ✔️ |
| 2. 推送任务正确入队到Redis | ✔️ |
| 3. 后台消费者正常处理任务 | ✔️ |
| 4. 推送失败时触发重试机制 | ✔️ |

---

## 🔹 阶段 3：实时消息推送完善

### 📌 开发文档

**目标**  
完善实时推送功能，确保消息及时准确送达。

**功能节点**
- Redis Pub/Sub集成：用户频道订阅
- 推送消息格式标准化
- 离线用户处理：消息持久化
- 推送状态跟踪：送达确认

**关键设计**
- 频道命名规范：`user:{user_id}:messages`
- 消息去重机制
- 推送优先级支持

---

### ✅ 验收标准

| 测试项 | 预期结果 |
|--------|--------|
| 1. 在线用户实时收到消息推送 | ✔️ |
| 2. 离线用户消息正确存储 | ✔️ |
| 3. 消息格式规范统一 | ✔️ |
| 4. 推送状态可追踪 | ✔️ |

---

## 🔹 阶段 4：离线消息同步增强

### 📌 开发文档

**目标**  
基于现有消息查询API，增强离线消息同步功能。

**当前状态分析**
- ✅ 已有消息列表查询API
- ✅ 已有消息标记已读功能
- ❌ 缺少专门的未读消息API
- ❌ 缺少自动同步机制

**功能节点**
- 扩展现有API：添加未读消息过滤
- WebSocket连接时自动推送未读消息
- 消息同步状态管理
- 分页和性能优化

**关键设计**
- 复用现有查询逻辑
- 支持增量同步
- 同步状态持久化

---

### ✅ 验收标准

| 测试项 | 预期结果 |
|--------|--------|
| 1. 离线期间的消息能正确同步 | ✔️ |
| 2. WebSocket连接时自动推送未读消息 | ✔️ |
| 3. 分页查询性能良好 | ✔️ |
| 4. 同步状态准确跟踪 | ✔️ |

---

## 🔹 阶段 5：系统监控与可靠性

### 📌 开发文档

**目标**  
添加系统监控和可靠性保障机制。

**功能节点**
- 消息推送监控：成功率、延迟统计
- 系统健康检查：Redis连接、WebSocket状态
- 日志增强：结构化日志记录
- 性能指标：Prometheus集成（可选）

**关键设计**
- 与现有日志系统集成（loguru）
- 监控数据可视化
- 告警机制配置

---

### ✅ 验收标准

| 测试项 | 预期结果 |
|--------|--------|
| 1. 推送成功率监控正常 | ✔️ |
| 2. 系统健康状态可查询 | ✔️ |
| 3. 日志记录完整准确 | ✔️ |
| 4. 性能指标可获取 | ✔️ |

---

## 🗺️ 实施路线图

### 阶段依赖关系
```
阶段 0 (Redis集成) → 阶段 1 (WebSocket扩展) → 阶段 2 (异步分发)
                                                        ↓
                                                   阶段 3 (实时推送)
                                                        ↓
                                                   阶段 4 (离线同步)
                                                        ↓
                                                   阶段 5 (监控可靠性)
```

### 开发优先级
1. **高优先级**：阶段 0、1、2（核心功能）
2. **中优先级**：阶段 3、4（用户体验）
3. **低优先级**：阶段 5（运维监控）

### 风险评估
- **技术风险**：Redis集成可能影响现有功能 → 采用渐进式升级
- **兼容性风险**：新功能可能破坏现有API → 保持向后兼容
- **性能风险**：WebSocket连接数增加 → 连接池管理和限流

### 回滚策略
- 每个阶段独立部署，支持快速回滚
- Redis功能可选，支持降级到数据库模式
- 保持现有API完全兼容

---

## 📋 实施检查清单

### 开发过程
- [ ] 每个阶段完成后进行完整测试
- [ ] 代码审查和安全检查
- [ ] 性能测试和压力测试
- [ ] 文档更新和API文档同步

---
