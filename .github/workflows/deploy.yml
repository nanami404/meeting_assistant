name: 部署会议助手到 Ubuntu 24.04

on:
  push:
    branches: [ main ]  # 只在推送到 main 分支时触发

jobs:
  deploy:
    name: 通过 SSH 部署
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 部署到远程服务器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /var/www/myapp
            echo "🔄 正在从 GitHub 拉取最新代码..."
            git pull origin main

            echo "📦 正在安装/更新 Python 依赖..."
            /var/www/myapp/venv/bin/pip install -r requirements.txt

            echo "🛑 正在停止已存在的 FastAPI 进程..."
            pkill -f "uvicorn main:app" || true

            echo "🚀 正在启动 FastAPI 应用..."
            nohup /var/www/myapp/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2 > app.log 2>&1 &

            echo "✅ 部署成功，时间：$(date)"
            echo "📄 app.log 文件尾日志："
            tail app.log