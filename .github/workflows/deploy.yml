name: éƒ¨ç½²ä¼šè®®åŠ©æ‰‹åˆ° Ubuntu 24.04

on:
  push:
    branches: [ main ]  # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch: {}  # æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²

jobs:
  deploy:
    name: é€šè¿‡ SSH éƒ¨ç½²
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨
        uses: meeting_assistantleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            cd /var/www/meeting_assistant || exit 1

            echo "ğŸ”„ æ­£åœ¨ä» GitHub æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main

            echo "ğŸ“¦ æ­£åœ¨å®‰è£…/æ›´æ–° Python ä¾èµ–..."
            if [ ! -d "/var/www/meeting_assistant/venv" ]; then
              echo "âœ¨ æœªå‘ç° venvï¼Œæ­£åœ¨åˆ›å»º..."
              python3 -m venv /var/www/meeting_assistant/venv
            fi

            # å‡çº§ pipï¼ˆä½¿ç”¨æ¸…åé•œåƒï¼‰
            /var/www/meeting_assistant/venv/bin/python -m pip install --upgrade pip \
              -i https://pypi.tuna.tsinghua.edu.cn/simple \
              --trusted-host pypi.tuna.tsinghua.edu.cn

            # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨æ¸…åé•œåƒ + æ— ç¼“å­˜ï¼‰
            /var/www/meeting_assistant/venv/bin/pip install --no-cache-dir -r requirements.txt \
              -i https://pypi.tuna.tsinghua.edu.cn/simple \
              --trusted-host pypi.tuna.tsinghua.edu.cn

            #echo "ğŸ›‘ æ­£åœ¨åœæ­¢å·²å­˜åœ¨çš„ FastAPI è¿›ç¨‹..."
            pkill uvicorn || true   

            echo "ğŸš€ æ­£åœ¨å¯åŠ¨ FastAPI åº”ç”¨..."
            nohup /var/www/blog/venv/bin/python -m uvicorn main:meeting_assistant --host 0.0.0.0 --port 8000 --workers 2 > meeting_assistant.log 2>&1 &
            echo "âœ… FastAPI å·²åœ¨åå°è¿è¡Œï¼ŒPID: $APP_PID"

            # ç­‰å¾…æ—¥å¿—æ–‡ä»¶ç”Ÿæˆ
            sleep 2

            echo "âœ… éƒ¨ç½²æˆåŠŸï¼Œæ—¶é—´ï¼š$(date)"
            if [ -f meeting_assistant.log ]; then
              echo "ğŸ“„ æœ€è¿‘ 50 è¡Œåº”ç”¨æ—¥å¿—ï¼š"
              tail -n 50 meeting_assistant.log
            else
              echo "âš ï¸ meeting_assistant.log å°šæœªç”Ÿæˆï¼Œä½†åº”ç”¨å·²åœ¨åå°å¯åŠ¨ã€‚"
            fi
