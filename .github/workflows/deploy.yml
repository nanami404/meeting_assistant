name: 部署会议助手到 Ubuntu 24.04

on:
  push:
    branches: [ main ]  # 只在推送到 main 分支时触发
  workflow_dispatch: {}  # 支持手动触发部署

jobs:
  deploy:
    name: 通过 SSH 部署
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 部署到远程服务器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            cd /var/www/blog || exit 1

            echo "🔄 正在从 GitHub 拉取最新代码..."
            git pull origin main

            echo "📦 正在安装/更新 Python 依赖..."
            if [ ! -d "/var/www/blog/venv" ]; then
              echo "✨ 未发现 venv，正在创建..."
              python3 -m venv /var/www/blog/venv
            fi

            # 升级 pip（使用清华镜像）
            /var/www/blog/venv/bin/python -m pip install --upgrade pip \
              -i https://pypi.tuna.tsinghua.edu.cn/simple \
              --trusted-host pypi.tuna.tsinghua.edu.cn

            # 安装依赖（使用清华镜像 + 无缓存）
            /var/www/blog/venv/bin/pip install --no-cache-dir -r requirements.txt \
              -i https://pypi.tuna.tsinghua.edu.cn/simple \
              --trusted-host pypi.tuna.tsinghua.edu.cn

            #echo "🛑 正在停止已存在的 FastAPI 进程..."
            pkill uvicorn || true   

            echo "🚀 正在启动 FastAPI 应用..."
            nohup /var/www/blog/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2 > app.log 2>&1 &
            echo "✅ FastAPI 已在后台运行，PID: $APP_PID"

            # 等待日志文件生成
            sleep 2

            echo "✅ 部署成功，时间：$(date)"
            if [ -f app.log ]; then
              echo "📄 最近 50 行应用日志："
              tail -n 50 app.log
            else
              echo "⚠️ app.log 尚未生成，但应用已在后台启动。"
            fi
